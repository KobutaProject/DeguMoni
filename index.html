<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‡ã‚°ãƒ¼ç’°å¢ƒãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function DeguMonitoringDashboard() {
      const [data, setData] = useState([]);
      const [latestData, setLatestData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [lastUpdate, setLastUpdate] = useState(null);
      const [dataRange, setDataRange] = useState(100);
      const [error, setError] = useState(null);
      const [updateKey, setUpdateKey] = useState(0);

      // å¥åº·è¨˜éŒ²é–¢é€£ã®state
      const [healthRecords, setHealthRecords] = useState([]);
      const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);
      const [weight, setWeight] = useState('');
      const [fecesCondition, setFecesCondition] = useState('');
      const [memo, setMemo] = useState('');

      const CHANNEL_ID = '77767';
      const READ_KEY = '73ff0a03269c1f35';
      const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbygafxILyUYiajSYjThZeIezQS5SLzodxgjkfnmRFcqBEUo_iRS4MCeSUmlHsvl8XinVw/exec';

      const fetchData = async () => {
        try {
          setError(null);
          
          const timestamp = Date.now();
          const random = Math.random().toString(36).substring(7);
          const apiUrl = `https://ambidata.io/api/v2/channels/${CHANNEL_ID}/data?readKey=${READ_KEY}&n=${dataRange}&_t=${timestamp}&_r=${random}`;
          
          console.log('ğŸ”„ ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹:', new Date().toLocaleTimeString());
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-store',
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          
          if (result && result.length > 0) {
            const sortedData = result.reverse();
            
            const formattedData = sortedData.map(item => ({
              ...item,
              time: new Date(item.created).toLocaleString('ja-JP', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              }),
              timeOnly: new Date(item.created).toLocaleString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
              }),
              fullTime: new Date(item.created).toLocaleString('ja-JP')
            }));
            
            setData([...formattedData]);
            setLatestData({...formattedData[formattedData.length - 1]});
            setLastUpdate(new Date());
            setUpdateKey(prev => prev + 1);
            console.log('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†:', formattedData.length, 'ä»¶');
            console.log('ğŸ“Š æœ€æ–°:', formattedData[formattedData.length - 1].fullTime);
          }
          setLoading(false);
        } catch (error) {
          console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error.message);
          setError(error.message);
          setLoading(false);
        }
      };

      // å¥åº·è¨˜éŒ²ã‚’å–å¾—
      const fetchHealthRecords = async () => {
        try {
          const response = await fetch(GOOGLE_SCRIPT_URL);
          const records = await response.json();
          setHealthRecords(records);
          console.log('âœ… å¥åº·è¨˜éŒ²å–å¾—:', records.length, 'ä»¶');
        } catch (error) {
          console.error('âŒ å¥åº·è¨˜éŒ²å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }
      };

      // å¥åº·è¨˜éŒ²ã‚’ä¿å­˜
      const saveHealthRecord = async () => {
        if (!weight) {
          alert('ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        try {
          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              date: recordDate,
              weight: parseFloat(weight),
              fecesCondition: fecesCondition,
              memo: memo
            })
          });
          
          alert('âœ… è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
          setWeight('');
          setFecesCondition('');
          setMemo('');
          
          // å†èª­ã¿è¾¼ã¿
          setTimeout(() => fetchHealthRecords(), 1000);
        } catch (error) {
          console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆno-corsãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ç¢ºèªä¸å¯ï¼‰');
          setTimeout(() => fetchHealthRecords(), 1000);
        }
      };

      useEffect(() => {
        fetchData();
        fetchHealthRecords();
        console.log('â° è‡ªå‹•æ›´æ–°: 3åˆ†æ¯');
        const interval = setInterval(() => {
          console.log('ğŸ”„ è‡ªå‹•æ›´æ–°å®Ÿè¡Œ');
          fetchData();
          fetchHealthRecords();
        }, 3 * 60 * 1000);
        
        return () => clearInterval(interval);
      }, [dataRange]);

      if (loading) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
            <div className="text-center">
              <div className="text-2xl font-bold text-indigo-600 mb-4">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
            <div className="bg-white rounded-lg shadow-lg p-8 max-w-md">
              <div className="text-red-600 text-xl font-bold mb-4">âš ï¸ ã‚¨ãƒ©ãƒ¼</div>
              <div className="text-gray-700 mb-4">{error}</div>
              <div className="text-sm text-gray-500 mb-4">
                ãƒ–ãƒ©ã‚¦ã‚¶ãŒAmbient APIã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
              </div>
              <button 
                onClick={() => {
                  setLoading(true);
                  setError(null);
                  fetchData();
                }}
                className="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
              >
                å†è©¦è¡Œ
              </button>
            </div>
          </div>
        );
      }

      return (
        <div key={updateKey} className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-7xl mx-auto">
            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                  <h1 className="text-3xl font-bold text-gray-800 mb-2">
                    ğŸ¹ ãƒ‡ã‚°ãƒ¼ç’°å¢ƒãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
                  </h1>
                  <p className="text-gray-600">ãƒãƒ£ãƒ³ãƒãƒ«: DeguMoni_Integrated (ID: {CHANNEL_ID})</p>
                </div>
                <div className="text-right">
                  <div className="text-sm text-gray-500 mb-2">
                    æœ€çµ‚æ›´æ–°: {lastUpdate?.toLocaleString('ja-JP')}
                  </div>
                  <div className="text-xs text-gray-400 mb-2">
                    æ¬¡å›æ›´æ–°: 3åˆ†å¾Œï¼ˆè‡ªå‹•ï¼‰
                  </div>
                  <div className="flex gap-2">
                    <select 
                      value={dataRange}
                      onChange={(e) => setDataRange(Number(e.target.value))}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    >
                      <option value={50}>50ä»¶</option>
                      <option value={100}>100ä»¶</option>
                      <option value={300}>300ä»¶</option>
                      <option value={600}>600ä»¶</option>
                    </select>
                    <button
                      onClick={() => {
                        console.log('ğŸ”˜ æ‰‹å‹•æ›´æ–°');
                        fetchData();
                        fetchHealthRecords();
                      }}
                      className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                    >
                      ğŸ”„ ä»Šã™ãæ›´æ–°
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* å¥åº·è¨˜éŒ²å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h2 className="text-xl font-bold mb-4 text-gray-800">ğŸ“ å¥åº·è¨˜éŒ²ã‚’è¿½åŠ </h2>
              <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    æ—¥ä»˜
                  </label>
                  <input 
                    type="date" 
                    value={recordDate}
                    onChange={(e) => setRecordDate(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    ä½“é‡ (g)
                  </label>
                  <input 
                    type="number" 
                    value={weight}
                    onChange={(e) => setWeight(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="250"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    ç³ã®çŠ¶æ…‹
                  </label>
                  <select 
                    value={fecesCondition}
                    onChange={(e) => setFecesCondition(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                  >
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="normal">æ­£å¸¸</option>
                    <option value="soft">è»Ÿä¾¿</option>
                    <option value="hard">ç¡¬ã„</option>
                    <option value="diarrhea">ä¸‹ç—¢</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    ãƒ¡ãƒ¢
                  </label>
                  <input 
                    type="text"
                    value={memo}
                    onChange={(e) => setMemo(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="æ°—ã¥ã„ãŸã“ã¨ãªã©"
                  />
                </div>

                <div className="flex items-end">
                  <button
                    onClick={saveHealthRecord}
                    className="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                  >
                    ğŸ’¾ ä¿å­˜
                  </button>
                </div>
              </div>

              {/* å¥åº·è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ« */}
              {healthRecords.length > 0 && (
                <div className="mt-6">
                  <h3 className="text-lg font-bold mb-3 text-gray-800">ğŸ“Š è¨˜éŒ²å±¥æ­´ï¼ˆæœ€æ–°10ä»¶ï¼‰</h3>
                  <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ—¥ä»˜</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä½“é‡ (g)</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç³ã®çŠ¶æ…‹</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ãƒ¡ãƒ¢</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {healthRecords.slice(-10).reverse().map((record, idx) => (
                          <tr key={idx} className="hover:bg-gray-50">
                            <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                              {new Date(record.date).toLocaleDateString('ja-JP')}
                            </td>
                            <td className="px-4 py-2 whitespace-nowrap text-sm font-semibold text-green-600">
                              {record.weight}g
                            </td>
                            <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                              {record.fecesCondition}
                            </td>
                            <td className="px-4 py-2 text-sm text-gray-900">
                              {record.memo}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>

            {/* æœ€æ–°å€¤è¡¨ç¤º - 5ã¤ã®ãƒœãƒƒã‚¯ã‚¹ */}
            {latestData && (
              <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="text-sm text-gray-500 mb-1">æ¸©åº¦</div>
                  <div className="text-3xl font-bold text-orange-600">{latestData.d3}Â°C</div>
                  <div className="text-xs text-gray-400 mt-1">THU-TEMP</div>
                </div>
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="text-sm text-gray-500 mb-1">æ¹¿åº¦</div>
                  <div className="text-3xl font-bold text-blue-600">{latestData.d4}%</div>
                  <div className="text-xs text-gray-400 mt-1">THU-HUM</div>
                </div>
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="text-sm text-gray-500 mb-1">èµ°è¡Œè·é›¢</div>
                  <div className="text-3xl font-bold text-red-600">{latestData.d1}</div>
                  <div className="text-xs text-gray-400 mt-1">ROT-ACUM</div>
                </div>
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="text-sm text-gray-500 mb-1">é£²æ°´ç´¯ç©</div>
                  <div className="text-3xl font-bold text-cyan-600">{latestData.d6}</div>
                  <div className="text-xs text-gray-400 mt-1">DRK-ACUM</div>
                </div>
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="text-sm text-gray-500 mb-1">SIT</div>
                  <div className="text-3xl font-bold text-green-600">{latestData.d8}</div>
                  <div className="text-xs text-gray-400 mt-1">KUSA-ACUM</div>
                </div>
              </div>
            )}

            {/* ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼ */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4 text-gray-800">ğŸŒ¡ï¸ æ¸©æ¹¿åº¦æ¨ç§»</h2>
                <div className="space-y-3">
                  <DataRow label="ç¾åœ¨ã®æ¸©åº¦" value={`${latestData?.d3}Â°C`} trend={calculateTrend(data, 'd3')} />
                  <DataRow label="ç¾åœ¨ã®æ¹¿åº¦" value={`${latestData?.d4}%`} trend={calculateTrend(data, 'd4')} />
                  <DataRow label="å¹³å‡æ¸©åº¦" value={`${calculateAverage(data, 'd3')}Â°C`} />
                  <DataRow label="å¹³å‡æ¹¿åº¦" value={`${calculateAverage(data, 'd4')}%`} />
                </div>
              </div>

              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4 text-gray-800">ğŸ¡ æ´»å‹•ã‚µãƒãƒªãƒ¼</h2>
                <div className="space-y-3">
                  <DataRow label="å›è»¢é€Ÿåº¦" value={latestData?.d2} trend={calculateTrend(data, 'd2')} />
                  <DataRow label="èµ°è¡Œè·é›¢" value={latestData?.d1} />
                  <DataRow label="é£²æ°´ç´¯ç©" value={latestData?.d6} />
                  <DataRow label="SIT" value={latestData?.d8} />
                </div>
              </div>
            </div>

            {/* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              {/* æ¸©æ¹¿åº¦ã‚°ãƒ©ãƒ• */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4 text-gray-800">ğŸ“ˆ æ¸©åº¦ãƒ»æ¹¿åº¦ã‚°ãƒ©ãƒ•</h2>
                <ChartComponent 
                  data={data} 
                  datasets={[
                    { key: 'd3', label: 'æ¸©åº¦ (Â°C)', color: 'rgb(249, 115, 22)', yAxisID: 'y' },
                    { key: 'd4', label: 'æ¹¿åº¦ (%)', color: 'rgb(59, 130, 246)', yAxisID: 'y1' }
                  ]}
                  dual={true}
                />
              </div>

              {/* ROTã‚°ãƒ©ãƒ• */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4 text-gray-800">ğŸ“ˆ å›è»¢æ´»å‹•ã‚°ãƒ©ãƒ•</h2>
                <ChartComponent 
                  data={data} 
                  datasets={[
                    { key: 'd1', label: 'èµ°è¡Œè·é›¢', color: 'rgb(220, 38, 38)', yAxisID: 'y' },
                    { key: 'd2', label: 'å›è»¢é€Ÿåº¦', color: 'rgb(79, 70, 229)', yAxisID: 'y1' }
                  ]}
                  dual={true}
                />
              </div>

              {/* DRKã‚°ãƒ©ãƒ• */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4 text-gray-800">ğŸ“ˆ é£²æ°´ç´¯ç©ã‚°ãƒ©ãƒ•</h2>
                <ChartComponent 
                  data={data} 
                  datasets={[
                    { key: 'd6', label: 'é£²æ°´ç´¯ç©', color: 'rgb(6, 182, 212)', yAxisID: 'y' }
                  ]}
                  dual={false}
                />
              </div>

              {/* ä½“é‡ã‚°ãƒ©ãƒ• */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4 text-gray-800">ğŸ“ˆ ä½“é‡æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
                <HealthChartComponent healthRecords={healthRecords} />
              </div>
            </div>

            {/* ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4 text-gray-800">ğŸ“Š æœ€æ–°ãƒ‡ãƒ¼ã‚¿ï¼ˆ20ä»¶ï¼‰</h2>
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ™‚åˆ»</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ¸©åº¦</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ¹¿åº¦</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å›è»¢é€Ÿåº¦</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">èµ°è¡Œè·é›¢</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é£²æ°´</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SIT</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {data.slice(-20).reverse().map((row, idx) => (
                      <tr key={idx} className="hover:bg-gray-50">
                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{row.time}</td>
                        <td className="px-4 py-2 whitespace-nowrap text-sm font-semibold text-orange-600">{row.d3}Â°C</td>
                        <td className="px-4 py-2 whitespace-nowrap text-sm font-semibold text-blue-600">{row.d4}%</td>
                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{row.d2}</td>
                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{row.d1}</td>
                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{row.d5}</td>
                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{row.d8}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="text-center mt-8 pb-4">
              <p className="text-sm text-gray-600">
                ğŸ”„ è‡ªå‹•æ›´æ–°: 3åˆ†æ¯ | ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {data.length}ä»¶ | å¥åº·è¨˜éŒ²: {healthRecords.length}ä»¶
              </p>
            </div>
          </div>
        </div>
      );
    }

    // Chart.jsã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    function ChartComponent({ data, datasets, dual }) {
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      useEffect(() => {
        if (!chartRef.current || !data || data.length === 0) return;

        if (chartInstance.current) {
          chartInstance.current.destroy();
        }

        const ctx = chartRef.current.getContext('2d');

        const chartDatasets = datasets.map(ds => ({
          label: ds.label,
          data: data.map(item => item[ds.key]),
          borderColor: ds.color,
          backgroundColor: ds.color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
          tension: 0.4,
          yAxisID: ds.yAxisID
        }));

        const scales = {
          x: {
            display: true,
            ticks: {
              maxRotation: 45,
              minRotation: 45
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left'
          }
        };

        if (dual) {
          scales.y1 = {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false
            }
          };
        }

        chartInstance.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(item => item.timeOnly),
            datasets: chartDatasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return data[context[0].dataIndex].time;
                  }
                }
              }
            },
            scales: scales
          }
        });

        return () => {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
        };
      }, [data, datasets, dual]);

      return <canvas ref={chartRef}></canvas>;
    }

    // å¥åº·è¨˜éŒ²ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    function HealthChartComponent({ healthRecords }) {
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      useEffect(() => {
        if (!chartRef.current || !healthRecords || healthRecords.length === 0) return;

        if (chartInstance.current) {
          chartInstance.current.destroy();
        }

        const ctx = chartRef.current.getContext('2d');

        // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
        const sortedRecords = [...healthRecords].sort((a, b) => 
          new Date(a.date) - new Date(b.date)
        );

        chartInstance.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: sortedRecords.map(record => 
              new Date(record.date).toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' })
            ),
            datasets: [{
              label: 'ä½“é‡ (g)',
              data: sortedRecords.map(record => record.weight),
              borderColor: 'rgb(34, 197, 94)',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  afterLabel: function(context) {
                    const record = sortedRecords[context.dataIndex];
                    return [
                      `ç³: ${record.fecesCondition}`,
                      record.memo ? `ãƒ¡ãƒ¢: ${record.memo}` : ''
                    ].filter(Boolean);
                  }
                }
              }
            },
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left'
              }
            }
          }
        });

        return () => {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
        };
      }, [healthRecords]);

      if (!healthRecords || healthRecords.length === 0) {
        return (
          <div className="flex items-center justify-center h-48 text-gray-400">
            ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨˜éŒ²ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
          </div>
        );
      }

      return <canvas ref={chartRef}></canvas>;
    }

    function DataRow({ label, value, trend }) {
      return (
        <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span className="text-sm font-medium text-gray-700">{label}</span>
          <div className="flex items-center gap-2">
            <span className="text-lg font-bold text-gray-900">{value}</span>
            {trend && (
              <span className={`text-sm ${trend > 0 ? 'text-red-500' : 'text-blue-500'}`}>
                {trend > 0 ? 'â†‘' : 'â†“'}
              </span>
            )}
          </div>
        </div>
      );
    }

    function calculateAverage(data, key) {
      if (!data || data.length === 0) return '---';
      const sum = data.reduce((acc, item) => acc + (parseFloat(item[key]) || 0), 0);
      return (sum / data.length).toFixed(1);
    }

    function calculateTrend(data, key) {
      if (!data || data.length < 10) return null;
      const recent = data.slice(-5);
      const previous = data.slice(-10, -5);
      const recentAvg = recent.reduce((acc, item) => acc + (parseFloat(item[key]) || 0), 0) / 5;
      const previousAvg = previous.reduce((acc, item) => acc + (parseFloat(item[key]) || 0), 0) / 5;
      return recentAvg - previousAvg;
    }

    ReactDOM.render(<DeguMonitoringDashboard />, document.getElementById('root'));
  </script>
</body>
</html>
